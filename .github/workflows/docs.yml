name: Update Documentation

on:
  workflow_run:
    workflows: ["Tests"]
    types: [completed]
    branches: [ main ]

jobs:
  update-docs:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-24.04

    permissions:
      contents: write
    steps:
    - id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.REPO_AUTOMATION_BOT_APP_ID }}
        private-key: ${{ secrets.REPO_AUTOMATION_BOT_APP_SECRET }}

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ steps.app-token.outputs.token }}
        fetch-depth: 0
    
    - name: Ensure we're on main branch
      run: |
        git checkout main
        git pull origin main
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
    
    - name: Download dependencies
      run: go mod download
    
    - name: Generate documentation
      run: make docs
    
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add and commit changes
        git add docs/
        git commit -m "docs: auto-update CLI documentation [skip ci]"
        
        # Try to push directly first
        if git push origin main; then
          echo "Successfully pushed changes"
        else
          echo "Push failed, trying to pull and rebase..."
          # If push fails, pull latest changes and rebase
          git pull --rebase origin main
          # Push again
          git push origin main
        fi
